name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  # Optional: set at repo/org level (Settings → Variables → Actions)
  NEXT_PUBLIC_API_BASE: ${{ vars.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api/v1' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: meta
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="latest"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Build and push base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.base
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-base:3.11-slim
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push service images
        uses: docker/bake-action@v5
        with:
          push: true
          provenance: false
          no-cache: false
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
            document-processing.context=services/document-processing
            document-processing.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-document-processing-service:${{ steps.meta.outputs.tag }}
            vector-db.context=services/vector-db
            vector-db.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-vector-db-service:${{ steps.meta.outputs.tag }}
            llm-service.context=services/llm-service
            llm-service.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-llm-service:${{ steps.meta.outputs.tag }}
            api-gateway.context=services/api-gateway
            api-gateway.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-api-gateway-service:${{ steps.meta.outputs.tag }}
            frontend.context=frontend
            frontend.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-frontend:${{ steps.meta.outputs.tag }}
            frontend.args.NEXT_PUBLIC_API_BASE=${{ env.NEXT_PUBLIC_API_BASE }}
          files: |
            ./docker-bake.hcl
          # Fallback: inline target definitions if docker-bake.hcl is absent
          # The action supports inline definitions via set:, but some versions
          # require a file; we provide a minimal inline bake file next.

      - name: Generate bake file when missing
        if: ${{ failure() }}
        run: |
          cat > docker-bake.hcl <<'HCL'
          group "default" {
            targets = ["document-processing","vector-db","llm-service","api-gateway","frontend"]
          }
          target "document-processing" { dockerfile = "services/document-processing/Dockerfile" context = "services/document-processing" }
          target "vector-db" { dockerfile = "services/vector-db/Dockerfile" context = "services/vector-db" }
          target "llm-service" { dockerfile = "services/llm-service/Dockerfile" context = "services/llm-service" }
          target "api-gateway" { dockerfile = "services/api-gateway/Dockerfile" context = "services/api-gateway" }
          target "frontend" { dockerfile = "frontend/Dockerfile" context = "frontend" }
          HCL

      - name: Retry build and push service images (bake)
        if: ${{ always() && steps.meta.outcome == 'success' }}
        uses: docker/bake-action@v5
        with:
          push: true
          provenance: false
          no-cache: false
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
            document-processing.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-document-processing-service:${{ steps.meta.outputs.tag }}
            vector-db.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-vector-db-service:${{ steps.meta.outputs.tag }}
            llm-service.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-llm-service:${{ steps.meta.outputs.tag }}
            api-gateway.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-api-gateway-service:${{ steps.meta.outputs.tag }}
            frontend.tags=${{ env.REGISTRY }}/${{ env.OWNER }}/researcher-frontend:${{ steps.meta.outputs.tag }}
            frontend.args.NEXT_PUBLIC_API_BASE=${{ env.NEXT_PUBLIC_API_BASE }}
          files: |
            ./docker-bake.hcl
